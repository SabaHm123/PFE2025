pipeline {
  agent any

  environment {
    PROJECT_DIR = 'BackendPFE'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Clean Docker Containers') {
      steps {
        dir("${env.PROJECT_DIR}") {
          bat '''
            docker-compose down || echo "No containers to stop"
            docker rm -f mysql-sql-bsn mail-dev-bsn || echo "Containers already removed"
          '''
        }
      }
    }

    stage('Start MySQL and MailDev') {
      steps {
        dir("${env.PROJECT_DIR}") {
          bat 'docker-compose up -d'
        }
      }
    }

    stage('Build Project') {
      steps {
        dir("${env.PROJECT_DIR}") {
          bat 'mvnd clean package -DskipTests'

        }
      }
    }

    stage('Stop Docker Services') {
      steps {
        dir("${env.PROJECT_DIR}") {
          bat 'docker-compose down'
        }
      }
    }
  }

  post {
    always {
      echo 'Pipeline terminé.'
    }
    success {
      echo 'Build réussi.'
    }
    failure {
      echo 'Build échoué.'
    }
  }
}
