pipeline {
  agent {
    docker { image 'maven:3.9.10-eclipse-temurin-17' }
  }
  environment {
    PROJECT_DIR = 'BackendPFE'
  }
  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Clean Docker Containers') {
      steps {
        dir("${env.PROJECT_DIR}") {
          script {
            // Essaye d'arrêter et supprimer les containers, ignore erreur si ils n'existent pas
            bat '''
            docker-compose down || echo "No containers to stop"
            docker rm -f mysql-sql-bsn mail-dev-bsn || echo "Containers already removed"
            '''
          }
        }
      }
    }

    stage('Start MySQL and MailDev') {
      steps {
        dir("${env.PROJECT_DIR}") {
          bat 'docker-compose up -d'
        }
      }
    }

    stage('Build Project') {
      steps {
        dir("${env.PROJECT_DIR}") {
          sh 'mvn clean package -DskipTests'
        }
      }
    }

    // Ajouter ici d'autres stages comme tests, sonar, etc.

    stage('Stop Docker Services') {
      steps {
        dir("${env.PROJECT_DIR}") {
          bat 'docker-compose down'
        }
      }
    }
  }
  post {
    always {
      echo 'Pipeline terminé.'
    }
    success {
      echo 'Build réussi.'
    }
    failure {
      echo 'Build échoué.'
    }
  }
}
